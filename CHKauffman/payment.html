<p class="intro">C.H. Kauffman &amp; Associates offers secure, online payment. Please fill out all the required fields in the form and submit your payment.</p>
<div>
    <script type="text/javascript">
        const SESSION_KEY="paymentFormData"
        function checkForPdsTokenInUrl(){
            const urlSearchParams = new URLSearchParams(window.location.search);
            const params = Object.fromEntries(urlSearchParams.entries());
            if(params && params.pdsToken &&  params.pdsToken.length>0){
                readFromSessionStorage();
                setTimeout(()=>{onFieldchange();}, 500);
                processPayment(params.pdsToken, params.pdsPmtType);
                deletePdsTokenFromUrl();
            }
        }
        function readFromSessionStorage(){
            let data = sessionStorage.getItem(SESSION_KEY);
            sessionStorage.removeItem(SESSION_KEY);
            setFormData(JSON.parse(data))
            return JSON.parse(data);
        }
        function deletePdsTokenFromUrl(){
            const url = new URL(window.location.href)
            const params = new URLSearchParams(url.search.slice(1))
            params.delete('pdsToken');
            params.delete('pdsPmtType');
            window.history.replaceState({},'',`${window.location.pathname}?${params}${window.location.hash}`,)
        }
        function handleFormSubmit(event){
            var token = getValueFromField('pdsToken');
            var paymentType = getValueFromField('pdsPmtType');
            processPayment(token, paymentType);
        }
        function processPayment(token, paymentType){
            var data = getFormData();
            console.log('need to call API with following data ');
            console.log('customer info ', data);
            console.log('token ', token);
            makeAjaxCall(data, token);
        }
        function makeAjaxCall(customerData, token){
            var dataToPost ={
                MerchantKey:"55D0FAC7-1E72-485A-8A5B-44EDAC2AB4C4",
                Token:token,
                VerStr:"N",
                ...customerData,
                AdditionalSearch:"",
                AccountCode1:customerData.LoanNumber,
                AccountCode2:customerData.LLCName,
                AccountCode3:""//customerData.Email
            }
            unhideElement(document.getElementsByClassName('preloader')[0]);
            fetch("https://checkout.securepds.com/checkout/checkout.svc/json/SinglePayment", {
                            method:'POST',
                            mode: 'cors', // no-cors, *cors, same-origin
                            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                            credentials: 'same-origin',
                            headers: [['Content-Type', 'application/json'],],
                            body:JSON.stringify(dataToPost)
                        }).then(response=> {
                            response.json().then(res =>{
                                hideElement(document.getElementsByClassName('preloader')[0]);
                                console.log('this is the response ', res)
                                if(res.Status ==="failure"){
                                    // alert('Failure - ' + res.Message);
                                    document.getElementById('paymentErrorMessage').innerText = "ERROR: " +res.Message;
                                    hideElement(document.getElementById('paymentConfirmation'));
                                    unhideElement(document.getElementById('paymentForm'));
                                    unhideElement(document.getElementById('paymenErrorDiv'));
                                    // document.getElementById('paymenErrorDiv').scrollIntoView();
                                    document.body.scrollIntoView();
                                }else{
                                    document.getElementById('paymentConfirmationId').innerText = res.Confirmation;
                                    unhideElement(document.getElementById('paymentConfirmation'));
                                    hideElement(document.getElementById('paymentForm'));
                                    hideElement(document.getElementById('paymenErrorDiv'));
                                    document.getElementById('paymentConfirmation').scrollIntoView();
                                    // alert('All Good  Confirmation # - '+ res.Confirmation)
                                }
                            })
                        })
        }
        function hideElement(element){
            element.classList.add("hideDiv");
        }
        function unhideElement(element){
            element.classList.remove("hideDiv");
        }
        function onFieldchange(){
            var data =getFormData(); 
            if(data.FirstName.length > 0 && data.LastName.length > 0 
                && data.Address1.length > 0 && data.City.length > 0
                && data.Zip.length > 0 && data.State.length > 0
                && validateEmail(data.Email) && (data.LoanNumber.length>0 || data.LLCName.length>0)
                && Number.parseFloat(data.Amount)>0){
                document.getElementById('paymentform').className ="form-submit";
                document.getElementById('checkoutscript').setAttribute('pds-amount',data.Amount)
                document.getElementById('checkoutscript').setAttribute('pds-email',data.Email);
                if(iOS()){
                    sessionStorage.setItem(SESSION_KEY, JSON.stringify(data))
                }
            }else{
                document.getElementById('paymentform').className ="form-submit disabled";
            }
        }
        function getFormData(){
            return  {
                FirstName:getValueFromField('firstName'),
                LastName:getValueFromField('lastName'),
                Address1:getValueFromField('addressLine1'),
                Address2:getValueFromField('addressLine2'),
                City:getValueFromField('city'),
                State:getValueFromField('state'),
                Zip:getValueFromField('zip'),
                Amount:getValueFromField('amount'),
                LLCName:getValueFromField('llcName'),
                LoanNumber:getValueFromField('loanNumber'),
                Email:getValueFromField('email'),
            }
        }
        function getValueFromField(field){
            return document.getElementById(field)? document.getElementById(field).value:""
        }
        function setFormData(data){
                setFromFieldValue('firstName', data.FirstName);
                setFromFieldValue('lastName', data.LastName);
                setFromFieldValue('addressLine1',data.Address1);
                setFromFieldValue('addressLine2', data.Address2);
                setFromFieldValue('city', data.City);
                setFromFieldValue('state', data.State);
                setFromFieldValue('zip', data.Zip);
                setFromFieldValue('amount', data.Amount);
                setFromFieldValue('llcName', data.LLCName);
                setFromFieldValue('loanNumber', data.LoanNumber);
                setFromFieldValue('email', data.Email)
        }
        function setFromFieldValue(field, value){
            if(document.getElementById(field)){
                document.getElementById(field).value = value
            } 
        }
        function setInputFilter(textbox, inputFilter) {
        ["input", "keydown", "keyup", "mousedown", "mouseup", "select", "contextmenu", "drop"].forEach(function(event) {
            textbox.addEventListener(event, function() {
            if (inputFilter(this.value)) {
                this.oldValue = this.value;
                this.oldSelectionStart = this.selectionStart;
                this.oldSelectionEnd = this.selectionEnd;
            } else if (this.hasOwnProperty("oldValue")) {
                this.value = this.oldValue;
                this.setSelectionRange(this.oldSelectionStart, this.oldSelectionEnd);
            } else {
                this.value = "";
            }
            });
        });
    }
        function validateEmail(inputText){
            var mailformat = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/;
            return inputText.match(mailformat)
        }
        function iOS() {
            return ['iPad Simulator',
                'iPhone Simulator',
                'iPod Simulator',
                'iPad',
                'iPhone',
                'iPod'
            ].includes(navigator.platform)
            // iPad on iOS 13 detection
            || (navigator.userAgent.includes("Mac") && "ontouchend" in document)
        }
    </script>
    <div id="paymenErrorDiv" class="hideDiv">
        <div>There was an issue processing your payment.  Please try again.</div>
        <div id="paymentErrorMessage"></div>
    </div>

    <div id="paymentConfirmation" class="wpforms-confirmation-container-full wpforms-confirmation-scroll hideDiv">
        <p>Thank you for your payment. Your confirmation id is <span id="paymentConfirmationId"></span>
        <p>If you need further assistance please contact our office.</p>
    </div>
    <div id="paymentForm" class="inputFields" >
        <label for="firstName">First Name <span class="wpforms-required-label">*</span></label><input id="firstName" type="text" onInput="onFieldchange()"></input>
        <label for="lastName">Last Name <span class="wpforms-required-label">*</span></label><input id="lastName" type="text" onInput="onFieldchange()"></input>
        <label for="email">Email <span class="wpforms-required-label">*</span></label><input id="email" type="text" onInput="onFieldchange()"></input>
        <label for="addressLine1">Address Line 1 <span class="wpforms-required-label">*</span></label><input id="addressLine1" type="text" onInput="onFieldchange()"></input>
        <label for="addressLine2">Address Line 2</label><input id="addressLine2" type="text" onInput="onFieldchange()"></input>
        <label for="city">City <span class="wpforms-required-label">*</span></label><input id="city" type="text" onInput="onFieldchange()"></input>
        <label for="state">State <span class="wpforms-required-label">*</span></label>
        <select id="state" onchange="onFieldchange()"">
            <option value="">Select State</option>
            <option value="AL">Alabama</option>
            <option value="AK">Alaska</option>
            <option value="AZ">Arizona</option>
            <option value="AR">Arkansas</option>
            <option value="CA">California</option>
            <option value="CO">Colorado</option>
            <option value="CT">Connecticut</option>
            <option value="DE">Delaware</option>
            <option value="DC">District Of Columbia</option>
            <option value="FL">Florida</option>
            <option value="GA">Georgia</option>
            <option value="HI">Hawaii</option>
            <option value="ID">Idaho</option>
            <option value="IL">Illinois</option>
            <option value="IN">Indiana</option>
            <option value="IA">Iowa</option>
            <option value="KS">Kansas</option>
            <option value="KY">Kentucky</option>
            <option value="LA">Louisiana</option>
            <option value="ME">Maine</option>
            <option value="MD">Maryland</option>
            <option value="MA">Massachusetts</option>
            <option value="MI">Michigan</option>
            <option value="MN">Minnesota</option>
            <option value="MS">Mississippi</option>
            <option value="MO">Missouri</option>
            <option value="MT">Montana</option>
            <option value="NE">Nebraska</option>
            <option value="NV">Nevada</option>
            <option value="NH">New Hampshire</option>
            <option value="NJ">New Jersey</option>
            <option value="NM">New Mexico</option>
            <option value="NY">New York</option>
            <option value="NC">North Carolina</option>
            <option value="ND">North Dakota</option>
            <option value="OH">Ohio</option>
            <option value="OK">Oklahoma</option>
            <option value="OR">Oregon</option>
            <option value="PA">Pennsylvania</option>
            <option value="RI">Rhode Island</option>
            <option value="SC">South Carolina</option>
            <option value="SD">South Dakota</option>
            <option value="TN">Tennessee</option>
            <option value="TX">Texas</option>
            <option value="UT">Utah</option>
            <option value="VT">Vermont</option>
            <option value="VA">Virginia</option>
            <option value="WA">Washington</option>
            <option value="WV">West Virginia</option>
            <option value="WI">Wisconsin</option>
            <option value="WY">Wyoming</option>
        </select>
        <label for="zip">Zip Code <span class="wpforms-required-label">*</span></label><input id="zip" type="text" onInput="onFieldchange()"></input>
        <label for="llcName">Business Name </label><input id="llcName" type="text" maxlength="20" onInput="onFieldchange()"></input>
        <label for="loanNumber">Loan Number <span class="wpforms-required-label">*</span></label><input id="loanNumber" type="text" onInput="onFieldchange()" maxlength="20"></input>
        <label for="amount">Amount <span class="wpforms-required-label">*</span></label><input id="amount" type="text" onInput="onFieldchange()"></input>
        <p>&nbsp;</p>
        <div>
            <form id="paymentform" class="form-submit disabled" action="javascript:handleFormSubmit()" method="POST">
                <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script><script id="checkoutscript" src="https://checkout.securepds.com/checkout/checkout2.js" pds-key="55D0FAC7-1E72-485A-8A5B-44EDAC2AB4C4" pds-theme="blue" pds-image="https://chkauffman.com/wp-content/uploads/2021/06/chkauffman-mortgage-bankers-nj-chk.png" pds-name="C.H. Kauffman %26 Associates Inc." pds-description="Payment to C.H. Kauffman %26 Associates Inc." pds-button="Pay Now" pds-paymenttypes="achonly" pds-pinless="true" pds-pinlesscredit="false">
                </script>
            </form>
            <p>&nbsp;</p>
        </div>
    </div>
    <div id="paymentIOSNotSupported" class="hideDiv">
        Payments cannot be processed from an iOS device.
    </div>
    <div class="preloader hideDiv">
        <div class="status">&nbsp;</div>
    </div>

    <p>&nbsp;</p>
    <script>
        setInputFilter(document.getElementById("amount"), function(value) {return /^\d*\.?\d*$/.test(value);});
        checkForPdsTokenInUrl();
        if(iOS() && false){
            hideElement(document.getElementById('paymentConfirmation'));
            hideElement(document.getElementById('paymentForm'));
            hideElement(document.getElementById('paymenErrorDiv'));
            unhideElement(document.getElementById('paymentIOSNotSupported'));
        }
    </script>
</div>